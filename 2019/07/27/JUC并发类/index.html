<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content>
  <meta name="author" content="Mr Wang">
  <!-- Open Graph Data -->
  <meta property="og:title" content="J.U.Cå¹¶å‘ç±»">
  <meta property="og:description" content>
  <meta property="og:site_name" content="æ˜¥é£ä¸åŠä½ çš„ç¾ğŸ·">
  <meta property="og:type" content="article">
  <meta property="og:image" content="http://yoursite.com">
  
    <link rel="alternate" href="/atom.xml" title="æ˜¥é£ä¸åŠä½ çš„ç¾ğŸ·" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>æ˜¥é£ä¸åŠä½ çš„ç¾ğŸ·</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">J.U.Cå¹¶å‘ç±»</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/<your-github-username>">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<your-email-address>">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Mr Wang</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2019-07-27</span>
            <span class="time">16:51:47</span>
          </span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p><strong>çº¿ç¨‹ä¸å®‰å…¨çš„é«˜å¹¶å‘å®ç°</strong></p>
<pre><code>package com.example.demo.util;

import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Semaphore;

public class AtomicIntegerTest {
    //å®¢æˆ·ç«¯å‘èµ·1000ä¸ªè¯·æ±‚
    private static int CLIENT_COUNT = 1000;
    //100ä¸ªçº¿ç¨‹
    private static int THREAD_COUNT = 100;
    //æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œ,countå°±åŠ 1
    private static int count = 0;
    //åˆ›å»ºçº¿ç¨‹æ± 
    private static ExecutorService executorService = Executors.newCachedThreadPool();
    //æ¯æ¬¡åªå…è®¸100ä¸ªçº¿ç¨‹æ‰§è¡Œ
    private static Semaphore semaphore = new Semaphore(THREAD_COUNT);

    private static CountDownLatch countDownLatch = new CountDownLatch(CLIENT_COUNT);

    public static void main(String[] args) throws Exception {
        for (int i = 0; i &lt; CLIENT_COUNT; i++) {
            executorService.execute(() -&gt; {
                try {
                    //è·å¾—ä¸€ä¸ªè®¸å¯è¯
                    semaphore.acquire();
                    add();
                    //é‡Šæ”¾è®¸å¯è¯,å¦‚æœä¸é‡Šæ”¾,åé¢900ä¸ªä»»åŠ¡ä¸èƒ½æ‰§è¡Œ
                    semaphore.release();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                //å‡ä¸€
                countDownLatch.countDown();
            });
        }
        //ç­‰æ‰€æœ‰çº¿ç¨‹åšå®Œ
        countDownLatch.await();
        executorService.shutdown();
        System.out.println(&quot;countæ•°é‡&quot;+count);

    }

    public static void add() {
        count++;
    }
}
</code></pre><p>ç»“æœå¦‚ä¸‹  </p>
<pre><code>countæ•°é‡995</code></pre><p>100ä¸ªçº¿ç¨‹åŒæ—¶å»åšcount++å°±ä¼šå¼•å‘çº¿ç¨‹å®‰å…¨é—®é¢˜,çœ‹ä¸€ä¸‹çº¿ç¨‹å·¥ä½œåŸç†,JMMæ¨¡å‹<br><img src="/img/41.png" alt="å¦‚å›¾"><br>å› ä¸ºçº¿ç¨‹ä¹‹é—´æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥çº¿ç¨‹æ“ä½œæ—¶ä¸èƒ½ä¿è¯è‡ªå·±çš„å·¥ä½œå†…å­˜è¯»å–çš„å€¼æ˜¯æœ€æ–°çš„,æ‰€ä»¥å¼•å‘ä¸Šé¢é—®é¢˜  </p>
<hr>
<p><strong>çº¿ç¨‹å®‰å…¨çš„é«˜å¹¶å‘å®ç° AtomicInteger</strong>  </p>
<pre><code>package com.example.demo.util;

import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Semaphore;
import java.util.concurrent.atomic.AtomicInteger;

public class AtomicIntegerTest {
    //å®¢æˆ·ç«¯å‘èµ·1000ä¸ªè¯·æ±‚
    private static int CLIENT_COUNT = 1000;
    //100ä¸ªçº¿ç¨‹
    private static int THREAD_COUNT = 100;
    //åˆ›å»ºçº¿ç¨‹æ± 
    private static ExecutorService executorService = Executors.newCachedThreadPool();
    //æ¯æ¬¡åªå…è®¸100ä¸ªçº¿ç¨‹æ‰§è¡Œ
    private static Semaphore semaphore = new Semaphore(THREAD_COUNT);

    private static CountDownLatch countDownLatch = new CountDownLatch(CLIENT_COUNT);

    private static AtomicInteger atomicInteger=new AtomicInteger(0);

    public static void main(String[] args) throws Exception {
        for (int i = 0; i &lt; CLIENT_COUNT; i++) {
            executorService.execute(() -&gt; {
                try {
                    //è·å¾—ä¸€ä¸ªè®¸å¯è¯
                    semaphore.acquire();
                    add();
                    //é‡Šæ”¾è®¸å¯è¯,å¦‚æœä¸é‡Šæ”¾,åé¢900ä¸ªä»»åŠ¡ä¸èƒ½æ‰§è¡Œ
                    semaphore.release();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                //å‡ä¸€
                countDownLatch.countDown();
            });
        }
        //ç­‰æ‰€æœ‰çº¿ç¨‹åšå®Œ
        countDownLatch.await();
        executorService.shutdown();
        System.out.println(&quot;countæ•°é‡&quot;+atomicInteger);

    }

    public static void add() {
        atomicInteger.incrementAndGet();
    }
}
</code></pre><p><strong>AtomicInteger ä¿è¯åŸå­æ€§,é‡‡ç”¨çš„æ˜¯CASç®—æ³•</strong><br>CASæ˜¯Compare and Swap çš„æ„æ€ï¼Œæ¯”è¾ƒå¹¶æ“ä½œ.CASæ˜¯ä¸€ç§ä¹è§‚é”æŠ€æœ¯,å½“å¤šä¸ªçº¿ç¨‹å»ä¿®æ”¹åŒä¸€ä¸ªå˜é‡æ—¶,  åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ›´æ–°æˆåŠŸ,å…¶ä½™çº¿ç¨‹éƒ½å¤±è´¥,å¤±è´¥çº¿ç¨‹ä¸ä¼šæŒ‚èµ·,ä¼šä¸æ–­å°è¯•æ›´æ–°.<br>CASçš„ä¸‰ä¸ªæ“ä½œ,å†…å­˜å€¼(V),é¢„æœŸå€¼(A),æ–°å€¼(B),åªæœ‰å½“å†…å­˜å€¼å’Œé¢„æœŸå€¼ä¸€è‡´(V=A),æ‰ä¼šæ›´æ–°ä¸ºæ–°å€¼B<br>çœ‹æºç   </p>
<pre><code>/**
     * Atomically sets the value to the given updated value
     * if the current value {@code ==} the expected value.
     *
     * @param expect the expected value
     * @param update the new value
     * @return {@code true} if successful. False return indicates that
     * the actual value was not equal to the expected value.
     */
    public final boolean compareAndSet(int expect, int update) {
        return unsafe.compareAndSwapInt(this, valueOffset, expect, update);
    }</code></pre><p>thisè¡¨ç¤ºå½“å‰å¯¹è±¡,valueOffsetè¡¨ç¤ºå½“å‰çº¿ç¨‹å·¥ä½œå†…å­˜çš„å€¼,expectè¡¨ç¤ºä¸»å†…å­˜çš„å€¼,updateè¡¨ç¤ºè¦æ›´æ–°çš„å€¼  </p>
<hr>
<p>åŸå­æ›´æ–°åŸºæœ¬ç±»å‹çš„ AtomicIntegerï¼Œåªèƒ½æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœè¦åŸå­æ›´æ–°å¤šä¸ªå˜é‡ï¼Œå°±éœ€è¦ä½¿ç”¨è¿™ä¸ªåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æä¾›çš„ç±»<br><strong>AtomicReference</strong>ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹ã€‚<br><strong>AtomicReferenceFieldUpdater</strong>ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µã€‚  </p>
<p>å¦‚æœéœ€åŸå­åœ°æ›´æ–°æŸä¸ªç±»é‡Œçš„æŸä¸ªå­—æ®µæ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨åŸå­æ›´æ–°å­—æ®µç±»ï¼ŒAtomic åŒ…æä¾›äº†ä»¥ä¸‹ 3 ä¸ªç±»è¿›è¡ŒåŸå­å­—æ®µæ›´æ–°ã€‚<br><strong>AtomicIntegerFieldUpdater</strong>ï¼šåŸå­æ›´æ–°æ•´å‹çš„å­—æ®µçš„æ›´æ–°å™¨ã€‚<br><strong>AtomicLongFieldUpdater</strong>ï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨ã€‚<br><strong>AtomicStampedReference</strong>ï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºåŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</p>
<pre><code>package com.example.demo.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.experimental.Accessors;

import java.io.Serializable;

/**
 * &lt;p&gt;
 * 
 * &lt;/p&gt;
 *
 * @author wy
 * @since 2019-06-29
 */
@Data
@EqualsAndHashCode(callSuper = false)
@Accessors(chain = true)
public class Userinfo implements Serializable {

    private static final long serialVersionUID=1L;

    @TableId(value = &quot;id&quot;, type = IdType.AUTO)
    private Integer id;

    private String name;

    public volatile int age;//å¿…é¡»ä½¿ç”¨volatileæ ‡è¯†,å¹¶ä¸”æ˜¯éstati


}</code></pre><pre><code>package com.example.demo.util;

import com.example.demo.entity.Userinfo;

import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;

public class AtomicReferenceTest {

    private static AtomicIntegerFieldUpdater&lt;Userinfo&gt; atomicIntegerFieldUpdater = AtomicIntegerFieldUpdater.newUpdater(Userinfo.class, &quot;age&quot;);

    private static Userinfo userinfo;

    public static void main(String[] args) {

          userinfo=new Userinfo();
          userinfo.setAge(12);

          atomicIntegerFieldUpdater.incrementAndGet(userinfo);

        System.out.println(&quot;æ›´æ–°å:&quot;+atomicIntegerFieldUpdater.get(userinfo));


    }
}
</code></pre><pre><code>æ›´æ–°å:13
</code></pre><hr>
<p><strong>CountDownLatch ç”¨æ³•</strong><br>è¿™ä¸ªç±»ç”¨æ¥æ§åˆ¶çº¿ç¨‹ç­‰å¾…ï¼Œå¯ä»¥è®©æŸä¸ªçº¿ç¨‹ç­‰å¾…ç›´åˆ°å€’è®¡æ—¶ç»“æŸï¼Œå†å¼€å§‹æ‰§è¡Œã€‚</p>
<pre><code>package com.example.demo.util;

import java.util.concurrent.CountDownLatch;

public class CountDownLatchTest {

    private static CountDownLatch countDownLatch = new CountDownLatch(2);

    public static void main(String[] args)throws Exception{
        new Thread(() -&gt; {
            try {
                System.out.println(Thread.currentThread().getName() + &quot;æ­£åœ¨æ‰§è¡Œ...&quot;);
                Thread.sleep(1000);
                System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•...&quot;);
                countDownLatch.countDown();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        new Thread(() -&gt; {
            try {
                System.out.println(Thread.currentThread().getName() + &quot;æ­£åœ¨æ‰§è¡Œ..&quot;);
                Thread.sleep(1000);
                System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•..&quot;);
                countDownLatch.countDown();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        System.out.println(&quot;ç­‰å¾…2ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•...&quot;);
        countDownLatch.await();//è°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå®ƒä¼šç­‰å¾…ç›´åˆ°countå€¼ä¸º0æ‰ç»§ç»­æ‰§è¡Œ
      //  countDownLatch.await(10, TimeUnit.MICROSECONDS);
        System.out.println(&quot;2ä¸ªå­çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•&quot;);




    }

}
</code></pre><pre><code>Thread-0æ­£åœ¨æ‰§è¡Œ...
Thread-1æ­£åœ¨æ‰§è¡Œ..
ç­‰å¾…2ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•...
Thread-0æ‰§è¡Œå®Œæ¯•...
Thread-1æ‰§è¡Œå®Œæ¯•..
2ä¸ªå­çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•</code></pre><p><strong>CyclicBarrier çš„ç”¨æ³•</strong>  </p>
<pre><code>package com.example.demo.util;

import java.util.concurrent.BrokenBarrierException;
import java.util.concurrent.CyclicBarrier;

public class CyclicBarrierTest {

    private static CyclicBarrier cyclicBarrier=new CyclicBarrier(2, new Runnable() {
        @Override
        public void run() {
            System.out.println(&quot;å±éšœæ”¾å¼€å,ç«‹é©¬æ‰§è¡Œæˆ‘,åœ¨æ‰§è¡Œå…¶ä»–çº¿ç¨‹&quot;);
        }
    });

    public static void main(String[] args) throws Exception{
        new Thread(() -&gt; {
            try {
                System.out.println(Thread.currentThread().getName() + &quot;æ­£åœ¨æ‰§è¡Œ...&quot;);
                Thread.sleep(3000);
                cyclicBarrier.await();
                System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•...&quot;);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } catch (BrokenBarrierException e) {
                e.printStackTrace();
            }
        }).start();
        new Thread(() -&gt; {
            try {
                System.out.println(Thread.currentThread().getName() + &quot;æ­£åœ¨æ‰§è¡Œ..&quot;);
                Thread.sleep(1000);
                cyclicBarrier.await();
                System.out.println(Thread.currentThread().getName() + &quot;æ‰§è¡Œå®Œæ¯•..&quot;);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } catch (BrokenBarrierException e) {
                e.printStackTrace();
            }
        }).start();


    }
}
</code></pre><pre><code>Thread-0æ­£åœ¨æ‰§è¡Œ...
Thread-1æ­£åœ¨æ‰§è¡Œ..
å±éšœæ”¾å¼€å,ç«‹é©¬æ‰§è¡Œæˆ‘,åœ¨æ‰§è¡Œå…¶ä»–çº¿ç¨‹
Thread-0æ‰§è¡Œå®Œæ¯•...
Thread-1æ‰§è¡Œå®Œæ¯•.. </code></pre><p><strong>Semaphore ç”¨æ³•</strong>  </p>
<pre><code>package com.example.demo.util;

import java.time.LocalDateTime;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Semaphore;

public class SemaphoreTest {
   //åªå…è®¸5ä¸ªçº¿ç¨‹æ‰§è¡Œ
    private static int THREAD_COUNT = 5;

    private static Semaphore semaphore = new Semaphore(THREAD_COUNT);

    public static void main(String[] args) {

        ExecutorService executorService = Executors.newCachedThreadPool();

        for (int i = 0; i &lt; 100; i++) {
            executorService.execute(() -&gt; {
                try {
                    //è·å–ä¸€ä¸ªè®¸å¯è¯
                    semaphore.acquire();
                    System.out.println(LocalDateTime.now()+&quot;===&quot;+Thread.currentThread().getName());
                    doSomeThing();
                    //é‡Šæ”¾è®¸å¯è¯
                    semaphore.release();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            });
        }
        executorService.shutdown();
    }

    public static void doSomeThing() {
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

</code></pre><pre><code>2019-07-27T13:57:12.677===pool-1-thread-26
2019-07-27T13:57:12.679===pool-1-thread-27
2019-07-27T13:57:12.679===pool-1-thread-30
2019-07-27T13:57:12.679===pool-1-thread-28
2019-07-27T13:57:12.679===pool-1-thread-29
2019-07-27T13:57:17.678===pool-1-thread-31
2019-07-27T13:57:17.680===pool-1-thread-32
2019-07-27T13:57:17.680===pool-1-thread-33
2019-07-27T13:57:17.681===pool-1-thread-35
2019-07-27T13:57:17.681===pool-1-thread-34
2019-07-27T13:57:22.678===pool-1-thread-36
2019-07-27T13:57:22.682===pool-1-thread-38
2019-07-27T13:57:22.688===pool-1-thread-39
2019-07-27T13:57:22.688===pool-1-thread-40
2019-07-27T13:57:22.682===pool-1-thread-37
</code></pre><p>å°è¯•è·å–è®¸å¯è¯,æ²¡æœ‰è·å–åˆ°éƒ½ä¸æ‰§è¡Œ</p>
<pre><code>package com.example.demo.util;

import java.time.LocalDateTime;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Semaphore;

public class SemaphoreTest {
    private static int THREAD_COUNT = 5;

    private static Semaphore semaphore = new Semaphore(THREAD_COUNT);

    public static void main(String[] args) {

        ExecutorService executorService = Executors.newCachedThreadPool();

        for (int i = 0; i &lt; 10; i++) {
            executorService.execute(() -&gt; {
                    //å°è¯•è·å–ä¸€ä¸ªè®¸å¯è¯
                    if(semaphore.tryAcquire()){
                        System.out.println(LocalDateTime.now()+&quot;===&quot;+Thread.currentThread().getName());
                        doSomeThing();
                        //é‡Šæ”¾è®¸å¯è¯
                        semaphore.release();
                    }



            });
        }
        executorService.shutdown();
    }

    public static void doSomeThing() {
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre><pre><code>2019-07-27T14:03:57.117===pool-1-thread-1
2019-07-27T14:03:57.117===pool-1-thread-4
2019-07-27T14:03:57.117===pool-1-thread-3
2019-07-27T14:03:57.117===pool-1-thread-2
2019-07-27T14:03:57.117===pool-1-thread-5</code></pre>
        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

